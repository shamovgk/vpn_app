# Участие в разработке VPN App

Спасибо, что рассматриваете возможность внесения вклада в VPN App! Этот документ описывает процесс участия в проекте для обеспечения плавного и последовательного рабочего процесса.

## Начало работы
- Создайте форк репозитория на GitHub.
- Склонируйте ваш форк:
  ```bash
  git clone https://github.com/shamovgk/vpn_app.git
  cd vpn_app
  ```
- Установите зависимости:
  ```bash
  flutter pub get
  ```
- Убедитесь, что ваша среда соответствует требованиям (см. README.md).

## Общие рекомендации
 - Работайте в изолированной ветке и избегайте прямых изменений в main.
 - Если нужна помощь, создайте issue с тегом question или обратитесь к участникам команды.
 - Храните учетные данные (например, SSH-ключи или пароли) в безопасном месте и не коммить их в репозиторий.

## Сообщение об ошибках
- Используйте трекер GitHub Issues для сообщения об ошибках или предложения функций.
- Укажите четкое название и описание.
- Включите шаги для воспроизведения (для ошибок) или подробное предложение (для функций).
- Проверьте существующие задачи, чтобы избежать дублирования.

## Стратегия ветвления
- Основная ветка — `main`.
- Создавайте новую ветку для каждого вклада:
  - `feature/<имя-функции>` для новых функций (например, `feature/subscription-screen`).
  - `bugfix/<описание-ошибки>` для исправлений ошибок (например, `bugfix/login-error`).
  - `docs/<обновление-документации>` для обновлений документации (например, `docs/update-readme`).
  - `hotfix/<описание-проблемы>` для срочных исправлений (например, `hotfix/vpn-connection`).
- Используйте описательные имена с дефисами (например, `feature/add-vpn-protocol`).

## Рабочий процесс
- Начните с последней версии ветки `main`:
  ```bash
  git checkout main
  git pull origin main
  ```
- Создайте новую ветку:
  ```bash
  git checkout -b feature/ваша-функция
  ```
- Внесите изменения и протестируйте их:
  ```bash
  flutter test
  flutter run
  ```
- Зафиксируйте изменения с четким сообщением:
  ```bash
  git add .
  git commit -m "Добавьте описательное сообщение о коммите"
  ```
  Пример: Добавление интерфейса экрана подписки с выбором плана.
- Отправьте ветку на GitHub:
  ```bash
  git push origin feature/ваша-функция
  ```
- Создайте Pull Request (PR) на GitHub:
  - Направьте на ветку `main`.
  - Укажите четкое название и описание ваших изменений.
  - Ссылайтесь на связанные задачи (например, Fixes #123).
  - Убедитесь, что тесты проходят и проверки CI зеленые.
- Учитывайте обратную связь от ревьюеров. Для слияния требуется как минимум одно одобрение.
- После одобрения PR будет слит одним из участников команды, а ветка будет удалена.
- Не забудьте обновить локальный репозиторий:
  ```bash
  git checkout main
  git pull origin main
  git branch -d feature/ваша-функция  # Удалите ненужную ветку
  ```

### Разрешение конфликтов слияния
- Если возникли конфликты во время PR или слияния:
  - Откройте проблемные файлы в редакторе (например, VS Code).
  - Разрешите конфликты, отредактировав помеченные разделы.
  - Выполните:
    ```bash
    git add <файл>
    git commit
    git push origin feature/ваша-функция
    ```

### Случайно отправили изменения в неверную ветку
- Если изменения были отправлены в `main` или другую ветку по ошибке:
  - Создайте новую ветку для изменений:
    ```bash
    git checkout -b feature/ваша-функция
    ```
  - Отмените изменения в `main` (если они были отправлены):
    ```bash
    git checkout main
    git reset --hard HEAD~1  # Откат последнего коммита (внимание: данные могут быть потеряны)
    git push origin main --force  # Принудительное обновление `main`
    ```
  - Вернитесь к вашей ветке и продолжайте работу:
    ```bash
    git checkout feature/ваша-функция
    git push origin feature/ваша-функция
    ```

### Забыли выполнить `pull` из `main`
- Если ваша ветка `feature/ваша-функция` устарела, выполните `pull` из `main`:
  ```bash
  git checkout feature/ваша-функция # Переключитесь на вашу ветку
  git merge main # Слейте изменения из `main`
  ```
- Если возникнут конфликты, следуйте инструкциям в разделе "Разрешение конфликтов слияния".

## Стандарты кода
- Следуйте [руководству по стилю Flutter](https://dart.dev/effective-dart/style).
- Выполняйте `flutter format .` для форматирования кода.
- Выполняйте `flutter analyze` для выявления проблем.
- Пишите модульные и виджет-тесты для новых функций или исправлений ошибок (см. Testing).

## Тестирование
- Пишите тесты для новых функций и исправлений ошибок.
- Используйте `flutter test` для запуска модульных и виджет-тестов.
- Убедитесь, что покрытие тестами остается высоким (цель: >80%).
- Пример:
  ```dart
  testWidgets('Экран логина отображается корректно', (WidgetTester tester) async {
      await tester.pumpWidget(const MaterialApp(home: LoginScreen()));
      expect(find.text('Вход'), findsOneWidget);
  });

## База данных
### 1. Подключение к серверу
- Подключитесь к серверу по SSH. Замените `user` и `server-ip` на ваше имя пользователя и IP-адрес сервера:
  ```bash
  ssh user@server-ip
  ```

### 2. Просмотр каталогов
- Проверьте доступные каталоги в текущей директории:
  ```bash
  ls -d */
  ```
  Эта команда отображает все каталоги в текущем пути.

### 3. Переход в каталог проекта
- Перейдите в нужный каталог проекта (замените `project-directory` на реальное имя каталога, найденное на предыдущем шаге):
  ```bash
  cd project-directory
  ```

### 4. Просмотр файлов в каталоге
- Посмотрите все файлы в текущем каталоге, чтобы убедиться в наличии `node_modules`, `package-lock.json` и других файлов:
  ```bash
  ls
  ```

### 5. Удаление ненужных файлов
- Удалите каталог `node_modules` и файлы `package-lock.json` и `index.js` для очистки проекта:
  ```bash
  rm -rf node_modules package-lock.json index.js
  ```

### 6. Проверка удаления файлов
- Убедитесь, что файлы были удалены, просмотрев все файлы (включая скрытые) в каталоге:
  ```bash
  ls -la
  ```
  Проверьте, что `node_modules`, `package-lock.json` и `index.js` больше не отображаются.

### 7. Проверка запущенных процессов PM2
- Просмотрите список всех запущенных процессов PM2, чтобы проверить статус `vpn-server`:
  ```bash
  pm2 list
  ```

### 8. Остановка сервера VPN
- Остановите процесс `vpn-server`, если он запущен:
  ```bash
  pm2 stop vpn-server
  ```

### 9. Удаление процесса сервера VPN
- Удалите процесс `vpn-server` из управления PM2:
  ```bash
  pm2 delete vpn-server
  ```

### 10. Добавление новых файлов
- Добавьте новые файлы сервера через консоль Windows:
  ```bash
  scp -r path-to-file\index.js user@server-ip:~/project-directory/
  ```

### 11. Обновление модулей
- Обновите модули внутри каталога:
  ```bash
  npm install
  ```

### 12. Проверка добавления файлов
- Посмотрите все файлы в текущем каталоге, чтобы убедиться в наличии `node_modules`, `index.js` и других файлов:
  ```bash
  ls
  ```

### 13. Запуск сервера VPN
- Запустите приложение Node.js (`index.js`) и назначьте ему имя `vpn-server` в PM2:
  ```bash
  pm2 start index.js --name vpn-server
  ```

### 14. Тестирование API регистрации
- Отправьте POST-запрос к конечной точке регистрации для проверки работы API и сервера:
  ```bash
  curl -X POST -H "Content-Type: application/json" -d '{"username":"testuser","password":"testpass123","email":"test@example.com"}' http://localhost:3000/register
  ```
  Эта команда отправляет JSON-данные на конечную точку `/register`. Проверьте ответ, чтобы убедиться, что запрос выполнен успешно.

## Настройка WireGuard на сервере Ubuntu

WireGuard — это современный и простой в настройке VPN-протокол. Ниже приведены шаги для установки и конфигурации WireGuard на вашем новом сервере Ubuntu перед релизом приложения. Эти инструкции учитывают вашу текущую архитектуру с серверным кодом и скриптами для генерации ключей.

### Предварительные требования
- Доступ к серверу через SSH с правами root или sudo.
- Установленный Ubuntu (рекомендуется версия 20.04 или 22.04).
- Статический общедоступный IP-адрес сервера.
- Убедитесь, что порт 51820 (или другой, который вы выберете) открыт в брандмауэре и на стороне провайдера.
- Каталог `/root/vpn-server/` доступен и содержит скрипты `generate_vpn_key.sh` и `add_to_wg_conf.sh` (как указано в вашем коде).

## Шаги настройки

### 1. Обновление системы
- Обновите пакеты на сервере, чтобы избежать проблем с устаревшими версиями:
  ```bash
  sudo apt update && sudo apt upgrade -y
  ```

### 2. Установка WireGuard
- Установите WireGuard и необходимые инструменты:
  ```bash
  sudo apt install wireguard wireguard-tools -y
  ```

### 3. Создание приватного и публичного ключей сервера
- Сгенерируйте пару ключей для сервера (эти ключи будут использоваться в конфигурации):
  ```bash
  wg genkey | tee /etc/wireguard/privatekey | wg pubkey > /etc/wireguard/publickey
  ```
- Частный ключ будет сохранен в `/etc/wireguard/privatekey`.
- Публичный ключ будет сохранен в `/etc/wireguard/publickey`.
- Обновите `serverPublicKey` в эндпоинте `/get-vpn-config` (в вашем коде: `yrDYPAHAHQ3+2sdvCzQ+WHErdh0dNt+5fgJbukEMw6Fg0=`) этим публичным ключом.

### 4. Настройка базового конфигурационного файла WireGuard
- Создайте или отредактируйте файл конфигурации `/etc/wireguard/wg0.conf`:
  ```bash
  sudo nano /etc/wireguard/wg0.conf
  ```
- Вставьте следующую базовую конфигурацию, заменив значения на свои:
  ```
  [Interface]
  PrivateKey = <Ваш_приватный_ключ_сервера>
  Address = 10.0.0.1/24
  ListenPort = 51820
  PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
  PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
  ```
- Замените `<Ваш_приватный_ключ_сервера>` на содержимое файла `/etc/wireguard/privatekey`.
- Убедитесь, что интерфейс `eth0` соответствует вашему основному сетевому интерфейсу (проверьте с помощью `ip a`).

### 5. Настройка брандмауэра
- Разрешите трафик через порт WireGuard и включите IP-форвардинг:
  ```bash
  sudo ufw allow 51820/udp
  sudo sysctl -w net.ipv4.ip_forward=1
  sudo sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
  ```

### 6. Размещение скриптов
- Убедитесь, что скрипты находятся в каталоге `/root/vpn-server/`:
  - `generate_vpn_key.sh` (генерирует приватный ключ):
  - `add_to_wg_conf.sh` (добавляет клиента в `wg0.conf`):
- Дайте права на выполнение:
  ```bash
  sudo chmod +x /root/vpn-server/generate_vpn_key.sh
  sudo chmod +x /root/vpn-server/add_to_wg_conf.sh
  ```

### 7. Запуск WireGuard
- Активируйте и запустите службу WireGuard:
  ```bash
  sudo wg-quick up wg0
  sudo systemctl enable wg-quick@wg0
  ```

### 8. Тестирование интеграции с сервером
- Убедитесь, что сервер Node.js (на порту 3000) работает и использует те же пути к скриптам (`/root/vpn-server/`).
- Зарегистрируйте нового пользователя через эндпоинт `/register` и выполните верификацию через `/verify-email`. Это автоматически сгенерирует VPN-ключ и добавит клиента в `wg0.conf`.
- Проверьте статус WireGuard:
  ```bash
  sudo wg show
  ```
- Убедитесь, что новый клиент (с IP, например, `10.0.0.2`) отображается.

### Примечания
- Замените `<Ваш_IP_сервера>` и ключи на актуальные значения.
- Для нескольких клиентов сервер автоматически увеличивает `AllowedIPs` (начиная с `10.0.0.2/32`) благодаря `add_to_wg_conf.sh`.
- Регулярно проверяйте логи WireGuard:
  ```bash
  journalctl -u wg-quick@wg0
  ```
- Если возникают ошибки с выполнением скриптов, убедитесь, что пути `/root/vpn-server/` и права доступа корректны.

### Тестирование
- После настройки протестируйте VPN, подключившись с вашего устройства, и убедитесь, что приложение может взаимодействовать с новым сервером через API и WireGuard.
- Проверьте, что ключи генерируются и добавляются в `wg0.conf` корректно.

## Часто задаваемые вопросы (FAQ)

 - ### Что делать, если WireGuard не подключается?
    - Проверьте, открыт ли порт 51820 в брандмауэре (sudo ufw status) и у провайдера.
    - Убедитесь, что ключи совпадают между сервером и клиентом. 
 - ### Как проверить, работает ли API сервера?
    - Используйте команду из раздела "Тестирование API регистрации" и проверьте ответ в терминале.