<h1>Статистика</h1>

<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:24px;">
  <div class="card"><h3>Пользователи всего</h3><div class="kpi"><%= cards.totalUsers %></div></div>
  <div class="card"><h3>Активны (30д)</h3><div class="kpi"><%= cards.active30d %></div></div>
  <div class="card"><h3>Платные (актив.)</h3><div class="kpi"><%= cards.paidActive %></div></div>
  <div class="card"><h3>Триал (актив.)</h3><div class="kpi"><%= cards.trialActive %></div></div>
  <div class="card"><h3>Устройств всего</h3><div class="kpi"><%= cards.devicesTotal %></div></div>
  <div class="card"><h3>Регистраций (30д)</h3><div class="kpi"><%= cards.registrations30d %></div></div>
  <div class="card"><h3>Trial → Paid (30д)</h3>
    <div class="kpi"><%= cards.trialPaidRate %>%</div>
    <small><%= cards.trialPaidConverted %> из <%= cards.trialPaidTrials %></small>
  </div>
</div>

<h2>Доход за 30 дней по валютам</h2>
<% if (revenue30d && revenue30d.length) { %>
<table>
  <thead><tr><th>Валюта</th><th>Сумма</th></tr></thead>
  <tbody>
    <% revenue30d.forEach(r => { %>
      <tr><td><%= r.currency %></td><td><%= r.sum %></td></tr>
    <% }) %>
  </tbody>
</table>
<% } else { %><p>Нет данных.</p><% } %>

<h2>Разбивка устройств по платформам</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
  <div class="card">
    <h3>Все устройства</h3>
    <% if (devicesByOs && devicesByOs.length) { %>
      <table><thead><tr><th>OS</th><th>Кол-во</th></tr></thead><tbody>
        <% devicesByOs.forEach(r => { %>
          <tr><td><%= r.os %></td><td><%= r.n %></td></tr>
        <% }) %>
      </tbody></table>
    <% } else { %><p>Нет данных.</p><% } %>
  </div>
  <div class="card">
    <h3>Активны за 30 дней</h3>
    <% if (devicesByOsActive30 && devicesByOsActive30.length) { %>
      <table><thead><tr><th>OS</th><th>Кол-во</th></tr></thead><tbody>
        <% devicesByOsActive30.forEach(r => { %>
          <tr><td><%= r.os %></td><td><%= r.n %></td></tr>
        <% }) %>
      </tbody></table>
    <% } else { %><p>Нет данных.</p><% } %>
  </div>
</div>

<h2>ТОП пользователей по числу устройств</h2>
<% if (topByDevices && topByDevices.length) { %>
<table>
  <thead><tr><th>Username</th><th>Устройств</th></tr></thead>
  <tbody>
    <% topByDevices.forEach(r => { %>
      <tr><td><%= r.username %></td><td><%= r.devices %></td></tr>
    <% }) %>
  </tbody>
</table>
<% } else { %><p>Нет данных.</p><% } %>

<style>
.card { background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,0.05); }
.card h3 { margin:0 0 8px 0; font-size:14px; color:#555; font-weight:600; }
.kpi { font-size:28px; font-weight:700; }
table { width:100%; border-collapse: collapse; margin: 10px 0 18px 0; }
th, td { border: 1px solid #eee; padding: 8px 12px; text-align: left; }
th { background: #f7f7f7; }
</style>
